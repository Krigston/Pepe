#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ Git hooks –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –≤–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è

echo "üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Git hooks –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –≤–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è..."

# –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –¥–ª—è hooks, –µ—Å–ª–∏ –µ—ë –Ω–µ—Ç
mkdir -p .git/hooks

# –°–æ–∑–¥–∞–µ–º pre-commit hook –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —É–≤–µ–ª–∏—á–µ–Ω–∏—è –≤–µ—Ä—Å–∏–∏
cat > .git/hooks/pre-commit << 'EOF'
#!/bin/bash

# Pre-commit hook –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —É–≤–µ–ª–∏—á–µ–Ω–∏—è –≤–µ—Ä—Å–∏–∏
# –£–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç patch –≤–µ—Ä—Å–∏—é –ø—Ä–∏ –∫–∞–∂–¥–æ–º –∫–æ–º–º–∏—Ç–µ –≤ main –≤–µ—Ç–∫–µ

# –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â—É—é –≤–µ—Ç–∫—É
current_branch=$(git symbolic-ref --short HEAD)

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–∞—Ö–æ–¥–∏–º—Å—è –ª–∏ –º—ã –≤ main –≤–µ—Ç–∫–µ
if [ "$current_branch" = "main" ]; then
    echo "üîÑ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —É–≤–µ–ª–∏—á–µ–Ω–∏–µ –≤–µ—Ä—Å–∏–∏ –¥–ª—è main –≤–µ—Ç–∫–∏..."
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ –º–∞—Ä–∫–µ—Ä—ã –≤ –∫–æ–º–º–∏—Ç–µ
    commit_message=$(git log --format=%B -n 1 HEAD || echo "")
    
    # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø –≤–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ –∫–ª—é—á–µ–≤—ã–º —Å–ª–æ–≤–∞–º
    if [[ $commit_message == *"[major]"* ]] || [[ $commit_message == *"BREAKING CHANGE"* ]]; then
        version_type="major"
        echo "üî• –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è - —É–≤–µ–ª–∏—á–∏–≤–∞–µ–º MAJOR –≤–µ—Ä—Å–∏—é"
    elif [[ $commit_message == *"[minor]"* ]] || [[ $commit_message == *"feat:"* ]] || [[ $commit_message == *"‚ú®"* ]]; then
        version_type="minor"
        echo "‚ú® –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –Ω–æ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ - —É–≤–µ–ª–∏—á–∏–≤–∞–µ–º MINOR –≤–µ—Ä—Å–∏—é"
    else
        version_type="patch"
        echo "üêõ –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –∫–æ–º–º–∏—Ç - —É–≤–µ–ª–∏—á–∏–≤–∞–µ–º PATCH –≤–µ—Ä—Å–∏—é"
    fi
    
    # –ó–∞–ø—É—Å–∫–∞–µ–º —Å–∫—Ä–∏–ø—Ç —É–≤–µ–ª–∏—á–µ–Ω–∏—è –≤–µ—Ä—Å–∏–∏
    if node scripts/version-bump.js $version_type; then
        # –î–æ–±–∞–≤–ª—è–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã –≤ –∫–æ–º–º–∏—Ç
        git add package.json src/VersionManager.ts
        echo "‚úÖ –í–µ—Ä—Å–∏—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∞ –∏ –¥–æ–±–∞–≤–ª–µ–Ω–∞ –≤ –∫–æ–º–º–∏—Ç"
    else
        echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –≤–µ—Ä—Å–∏–∏"
        exit 1
    fi
else
    echo "‚ÑπÔ∏è  –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –≤–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –¥–ª—è main –≤–µ—Ç–∫–∏"
fi

exit 0
EOF

# –î–µ–ª–∞–µ–º hook –∏—Å–ø–æ–ª–Ω—è–µ–º—ã–º
chmod +x .git/hooks/pre-commit

# –°–æ–∑–¥–∞–µ–º post-commit hook –¥–ª—è –≤—ã–≤–æ–¥–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –≤–µ—Ä—Å–∏–∏
cat > .git/hooks/post-commit << 'EOF'
#!/bin/bash

# Post-commit hook –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –≤–µ—Ä—Å–∏–∏

# –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â—É—é –≤–µ—Ç–∫—É
current_branch=$(git symbolic-ref --short HEAD)

if [ "$current_branch" = "main" ]; then
    # –ß–∏—Ç–∞–µ–º —Ç–µ–∫—É—â—É—é –≤–µ—Ä—Å–∏—é –∏–∑ package.json
    if command -v node >/dev/null 2>&1; then
        version=$(node -p "require('./package.json').version")
        echo ""
        echo "üéÆ –í–µ—Ä—Å–∏—è –∏–≥—Ä—ã –æ–±–Ω–æ–≤–ª–µ–Ω–∞ –¥–æ: v$version"
        echo "üìù –ö–æ–º–º–∏—Ç –≤ main –≤–µ—Ç–∫–µ –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω"
        echo ""
    fi
fi
EOF

# –î–µ–ª–∞–µ–º hook –∏—Å–ø–æ–ª–Ω—è–µ–º—ã–º
chmod +x .git/hooks/post-commit

echo "‚úÖ Git hooks —É—Å–ø–µ—à–Ω–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã!"
echo ""
echo "üìã –ù–∞—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ hooks:"
echo "   - pre-commit: –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —É–≤–µ–ª–∏—á–µ–Ω–∏–µ –≤–µ—Ä—Å–∏–∏"
echo "   - post-commit: –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –≤–µ—Ä—Å–∏–∏"
echo ""
echo "üè∑Ô∏è  –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–∏–ø–æ–º –≤–µ—Ä—Å–∏–∏:"
echo "   - –û–±—ã—á–Ω—ã–π –∫–æ–º–º–∏—Ç ‚Üí PATCH (1.0.0 ‚Üí 1.0.1)"
echo "   - [minor] –∏–ª–∏ feat: ‚Üí MINOR (1.0.0 ‚Üí 1.1.0)"
echo "   - [major] –∏–ª–∏ BREAKING CHANGE ‚Üí MAJOR (1.0.0 ‚Üí 2.0.0)"
echo ""
echo "üéØ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –≤–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –≤ main –≤–µ—Ç–∫–µ"
